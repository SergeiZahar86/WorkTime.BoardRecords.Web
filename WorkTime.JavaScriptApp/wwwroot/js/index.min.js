document.getElementById("login").addEventListener("click",login),document.getElementById("callApi").addEventListener("click",callApi),document.getElementById("refresh").addEventListener("click",refresh),document.getElementById("logout").addEventListener("click",logout),document.getElementById("registration").addEventListener("click",setEmpl),document.getElementById("startTime").addEventListener("click",startTime),document.getElementById("endTime").addEventListener("click",endTime),document.getElementById("getList").addEventListener("click",getWorkedTime);var settings={userStore:new Oidc.WebStorageStateStore({store:window.localStorage}),authority:"https://localhost:10001",client_id:"client_id_js",response_type:"code",scope:"openid profile SwaggerAPI",redirect_uri:"https://localhost:9001/callback.html",silent_redirect_uri:"https://localhost:9001/refresh.html",post_logout_redirect_uri:"https://localhost:9001/index.html"},manager=new Oidc.UserManager(settings);let token;function login(){manager.signinRedirect()}function logout(){manager.signoutRedirect()}function refresh(){manager.signinSilent().then((function(e){print("Token refreshed",e)})).catch((function(e){print("Something went wrong")}))}function callApi(){manager.getUser().then((function(e){null===e&&print("Unauthorized");const t=new XMLHttpRequest;t.open("GET","https://localhost:7001/Api/GetAll"),t.onload=function(){200===t.status?print(t.responseText,t.response):print("Something went wrong",t)},t.setRequestHeader("Authorization","Bearer "+e.access_token),t.send()})).catch((function(e){print(e)}))}function print(e,t){document.getElementById("message").innerText=e||"",document.getElementById("data").innerText=t&&"object"==typeof t?JSON.stringify(t,null,5):""}function setEmpl(){console.log("вызов функции setEmpl"),console.log("токен : ","Bearer "+token),manager.getUser().then((function(e){null===e&&print("Unauthorized"),axios.post("https://localhost:7001/Api/SetEmpl",{Name:document.getElementById("nameUser").value,Password:document.getElementById("passwordUser").value},{headers:{Authorization:"Bearer "+token}}).then(e=>{console.log("ответ из setEmpl: ",e.data),document.getElementById("registration-status").innerText=e.data,document.getElementById("nameUser").value="",document.getElementById("passwordUser").value=""}).catch(e=>{console.error("ошибка в setEmpl ",e)})})).catch((function(e){print(e)}))}function startTime(){const e=new Date;console.log("вызов функции startTime"),console.log("токен : ","Bearer "+token),console.log("текущее время ",e.toLocaleTimeString("ru")),manager.getUser().then((function(t){null===t&&print("Unauthorized"),axios.post("https://localhost:7001/Api/SetStartTime",{IdUser:t.profile.sub,StartTime:e},{headers:{Authorization:"Bearer "+token}}).then(e=>{console.log("ответ из startTime: ",e),document.getElementById("worktimetable-status").innerText=e.data,getWorkedTime()}).catch(e=>{console.error("ошибка в startTime ",e),document.getElementById("worktimetable-status").innerText="есть незакрытые записи"})})).catch((function(e){print(e)}))}function endTime(){const e=new Date;console.log("вызов функции endTime"),console.log("токен : ","Bearer "+token),console.log("текущее время ",e.toLocaleTimeString("ru")),manager.getUser().then((function(t){null===t&&print("Unauthorized"),axios.post("https://localhost:7001/Api/SetEndTime",{IdUser:t.profile.sub,EndTime:e},{headers:{Authorization:"Bearer "+token}}).then(e=>{console.log("ответ из endTime: ",e),document.getElementById("worktimetable-status").innerText=e.data,getWorkedTime()}).catch(e=>{console.error("ошибка в endTime ",e),document.getElementById("worktimetable-status").innerText="Нет открытых записей"})})).catch((function(e){print(e)}))}function getWorkedTime(){console.log("вызов функции getWorkedTime"),console.log("токен : ","Bearer "+token),manager.getUser().then((function(e){null===e&&print("Unauthorized"),console.log("user.profile.sub ",e.profile.sub),axios.post("https://localhost:7001/Api/GetListTime",{UserId:e.profile.sub},{headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"}}).then(e=>{console.log("ответ из getWorkedTime: ",e),fillTable(e)}).catch(e=>{console.error("ошибка в getWorkedTime ",e.response.data)})})).catch((function(e){print(e)}))}function fillTable(e){var t=$("#table-main");t.empty(),e.data.length>0&&$.each(e.data,(function(e,n){var o=$("<tr>").append($("<td>").text(n.id),$("<td>").text(n.user.userName),$("<td>").text(n.startTime),$("<td>").text(n.endTime));t.append(o)}))}manager.getUser().then((function(e){e?(token=e.access_token,print("Log in success",e),console.log("id user:",e.profile.sub),console.log("access_token :",token),"Administrator"===e.profile.roles&&$(".registration").toggleClass("lock"),"Employee"===e.profile.roles&&($(".worktimetable").toggleClass("lock"),getWorkedTime())):(print("User not logged in"),$(".worktimetable").addClass("lock"),$(".registration").addClass("lock"))})),manager.events.addUserSignedOut((function(){print("User sing out. Good bye."),$(".worktimetable").addClass("lock"),$(".registration").addClass("lock")}));